name: Upstream Sync & Fix

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *" # 每天自动同步一次（可选）
  workflow_dispatch: # 允许你手动点击按钮触发

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      # 1. 检出你的代码
      - name: Checkout target repo
        uses: actions/checkout@v3
        with:
          ref: main  # 你的主分支名称，如果是 master 请修改这里
          fetch-depth: 0

      # 2. 配置 Git 用户
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      # 3. 添加上游仓库并拉取更新
      - name: Add Upstream and Merge
        run: |
          # 这里换成上游仓库地址 (SzeMeng76/LunaTV)
          git remote add upstream https://github.com/SzeMeng76/LunaTV.git
          git fetch upstream
          # 合并上游更新
          git merge upstream/main --no-edit

      # 4. 【核心步骤】强制修复 .nvmrc
      # EdgeOne 需要 Node 18+ 或 20+，这里我们强制写入一个兼容版本
      - name: Fix .nvmrc for EdgeOne
        run: |
          echo "Writing compatible Node version to .nvmrc..."
          echo "20.18.0" > .nvmrc
          
          # 也可以选择直接删除：
          # rm -f .nvmrc

      # 5. 提交并推送更改
      - name: Push changes
        run: |
          # 只有当文件有变化（比如 .nvmrc 被上游改坏了又被我们修好了）才提交
          if [[ -n $(git status -s) ]]; then
            git add .nvmrc
            git commit -m "chore: sync from upstream and fix .nvmrc for EdgeOne"
            git push origin main
          else
            echo "No changes to push."
          fi
